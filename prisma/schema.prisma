generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  VISUALIZER
}

enum PaymentStatus {
  PAID
  PARTIAL
  UNPAID
  CANCELLED
}

enum ReservationStatus {
  TENTATIVE
  CONFIRMED
  CANCELLED
  NO_SHOW
}

enum ReservationSource {
  AIRBNB
  BOOKING
  DIRECT
}

enum ExpenseType {
  COMMISSION
  TAX
  SUPPLY
}

enum NoteType {
  GLOBAL
  PERSONAL
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  phone     String?
  image     String?
  // role      Role     @default(VISUALIZER) // Role is now handled in UserSession per session
  isActive  Boolean  @default(true)
  isSuperAdmin Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  notes     Note[]
  reportedBlacklistEntries BlacklistEntry[]
  sessions  UserSession[]
}

model Session {
  id        String   @id @default(cuid())
  name      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users         UserSession[]
  departments   Department[]
  reservations  Reservation[]
  expenses      Expense[]
  supplies      Supply[]
  blacklist     BlacklistEntry[]
  settings      SystemSettings[]
  notes         Note[]
}

model UserSession {
  id        String   @id @default(cuid())
  userId    String
  sessionId String
  role      Role     @default(VISUALIZER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([userId, sessionId])
}


enum DepartmentType {
  APARTMENT
  PARKING
}

model Department {
  id          String   @id @default(cuid())
  type        DepartmentType @default(APARTMENT)
  name        String
  description String?
  address     String?
  wifiName    String?
  wifiPass    String?
  alias       String?
  basePrice   Float    @default(0)
  cleaningFee Float    @default(0)
  color       String   @default("#3b82f6")
  
  // Extended Operational Fields
  googleMapsLink String?
  keyLocation    String? // Locker/Llaves
  lockBoxCode    String? // Código Locker
  ownerName      String?
  meterLuz       String?
  meterGas       String?
  meterAgua      String?
  meterWifi      String? // N Cliente Internet
  inventoryNotes String? // Inventario Crítico
  airbnbLink     String?
  bookingLink    String?
  platformLinks  String? // Deprecated or keep for legacy, but user asked to split. I will remove it to force migration visually or keep it optional? I will replace it.
  
  images      String   @default("[]") // JSON string of image URLs
  bedCount    Int
  maxPeople   Int
  hasParking  Boolean  @default(false)
  isActive    Boolean  @default(true) 
  isArchived  Boolean  @default(false) // Soft delete (hidden from everything)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  reservations Reservation[]
  expenses     Expense[]

  sessionId String?
  session   Session? @relation(fields: [sessionId], references: [id])
}

model Reservation {
  id String @id @default(cuid())

  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])

  source ReservationSource @default(DIRECT)
  status ReservationStatus @default(TENTATIVE)

  // Guest Data
  guestName        String
  guestPhone       String?
  guestPeopleCount Int
  bedsRequired     Int     @default(1)

  // Dates
  checkIn  DateTime
  checkOut DateTime

  // Money
  totalAmount   Float
  depositAmount Float  @default(0)
  cleaningFee   Float  @default(0) // Snapshot of Dept cleaning fee
  amenitiesFee  Float  @default(0) // Snapshot of total active supplies cost
  groupId       String? // UUID to link split reservations
  currency      String @default("ARS") // "ARS" or "USD"
  exchangeRate  Float? // Stored rate if USD

  paymentStatus PaymentStatus @default(UNPAID)

  hasParking Boolean @default(false)

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessionId String?
  session   Session? @relation(fields: [sessionId], references: [id])
}
model Supply {
  id        String   @id @default(cuid())
  name      String
  cost      Float
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessionId String?
  session   Session? @relation(fields: [sessionId], references: [id])
}

model Expense {
  id          String      @id @default(cuid())
  type        ExpenseType
  description String
  amount      Float
  quantity    Int?        @default(1)
  unitPrice   Float?
  date        DateTime    @default(now())

  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])

  isDeleted Boolean  @default(false) // Soft delete
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessionId String?
  session   Session? @relation(fields: [sessionId], references: [id])
}

model Note {
  id        String   @id @default(cuid())
  content   String
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  type      NoteType @default(PERSONAL)

  sessionId String?
  session   Session? @relation(fields: [sessionId], references: [id])
}

model BlacklistEntry {
  id        String   @id @default(cuid())
  
  guestName   String
  guestPhone  String   // Normalized phone for matching
  reason      String
  
  // Reporter info
  reportedById String?
  reportedBy   User?   @relation(fields: [reportedById], references: [id], onDelete: SetNull)
  
  // Optional: Historical context from a reservation
  departmentName String?
  checkIn        DateTime?
  checkOut       DateTime?
  totalAmount    Float?
  
  isActive    Boolean  @default(true) // Soft delete
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  sessionId String?
  session   Session? @relation(fields: [sessionId], references: [id])
}
model SystemSettings {
  id        String   @id @default(cuid())
  key       String
  value     String
  updatedAt DateTime @updatedAt
  updatedBy String?

  sessionId String?
  session   Session? @relation(fields: [sessionId], references: [id])

  @@unique([sessionId, key])
}


